<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Management - Avatar Commerce</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9fb;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: #27293d;
            color: #fff;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }
        
        .logo span {
            color: #64dfdf;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-category {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            margin: 15px 20px 10px;
            letter-spacing: 1px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .menu-item.active {
            background-color: #5e60ce;
            color: #fff;
            border-left: 4px solid #64dfdf;
        }
        
        .menu-item i {
            margin-right: 10px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: absolute;
            bottom: 0;
            width: 100%;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #5e60ce;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .user-role {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .logout-btn {
            display: block;
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        /* Main content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background-color: #5e60ce;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            background-color: #4d4eb9;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn i {
            margin-right: 6px;
        }
        
        .btn-secondary {
            background-color: #f1f1fe;
            color: #5e60ce;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background-color: #e5e5fb;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .alert-error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }
        
        .alert-warning {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .alert-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Platform Cards */
        .platform-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .platform-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
        }

        .platform-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .platform-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .platform-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .platform-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }

        .platform-logo.amazon { background: linear-gradient(135deg, #ff9900, #ffb84d); }
        .platform-logo.rakuten { background: linear-gradient(135deg, #bf0000, #e60026); }
        .platform-logo.shareasale { background: linear-gradient(135deg, #0066cc, #3399ff); }
        .platform-logo.cj_affiliate { background: linear-gradient(135deg, #6b46c1, #8b5cf6); }
        .platform-logo.skimlinks { background: linear-gradient(135deg, #10b981, #34d399); }

        .platform-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .platform-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-connected {
            background: #dcfce7;
            color: #166534;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #b91c1c;
        }

        .platform-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #64748b;
        }

        .detail-value {
            font-weight: 500;
            color: #1e293b;
        }

        .platform-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Onboarding Guide */
        .onboarding-guide {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .onboarding-guide::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(50%, -50%);
        }

        .guide-content {
            position: relative;
            z-index: 1;
        }

        .guide-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .guide-description {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .guide-steps {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .guide-step {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #ef4444;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #5e60ce;
            box-shadow: 0 0 0 3px rgba(94, 96, 206, 0.1);
        }

        .form-help {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 5px;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .step.active .step-number {
            background: #5e60ce;
            color: white;
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-line {
            flex: 1;
            height: 2px;
            background: #e2e8f0;
            margin: 0 10px;
        }

        .step.completed .step-line {
            background: #10b981;
        }

        .step:last-child .step-line {
            display: none;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #5e60ce;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
        }

        /* Platform Selection */
        .platform-selection {
            display: grid;
            gap: 12px;
        }

        .platform-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .platform-option:hover {
            border-color: #5e60ce;
            background: #f8fafc;
        }

        .platform-option.selected {
            border-color: #5e60ce;
            background: #f8fafc;
        }

        .platform-option input[type="radio"] {
            margin-right: 15px;
            scale: 1.2;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .platform-cards {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: visible;
            }
            
            .sidebar-header {
                padding: 20px 0;
                text-align: center;
            }
            
            .logo span {
                display: none;
            }
            
            .menu-category {
                display: none;
            }
            
            .menu-item span {
                display: none;
            }
            
            .menu-item {
                padding: 15px 0;
                justify-content: center;
            }
            
            .menu-item i {
                margin-right: 0;
                font-size: 1.3rem;
            }
            
            .sidebar-footer {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .guide-steps {
                justify-content: center;
            }
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Sidebar navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">Avatar<span>Commerce</span></div>
        </div>
        
        <nav class="sidebar-menu">
            <div class="menu-category">GENERAL</div>
            <a href="dashboard.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="analytics.html" class="menu-item">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            
            <div class="menu-category">AVATAR</div>
            <a href="avatar-setup.html" class="menu-item">
                <i class="fas fa-robot"></i>
                <span>Avatar Setup</span>
            </a>
            <a href="voice-setup.html" class="menu-item">
                <i class="fas fa-microphone"></i>
                <span>Voice Setup</span>
            </a>
            <a href="knowledge.html" class="menu-item">
                <i class="fas fa-brain"></i>
                <span>Add Knowledge</span>
            </a>
            
            <div class="menu-category">AFFILIATE</div>
            <a href="affiliate-management.html" class="menu-item active">
                <i class="fas fa-link"></i>
                <span>Affiliate Management</span>
            </a>
            
            <div class="menu-category">ACCOUNT</div>
            <a href="settings.html" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        
            <button id="logout-btn" class="logout-btn">Sign Out</button>
        </div>
    </aside>

    <!-- Main content area -->
    <main class="main-content">
        <div class="header">
            <h1 class="page-title">Affiliate Management</h1>
            <div class="header-actions">
                <button id="connect-platform-btn" class="btn">
                    <i class="fas fa-plus"></i> Connect Platform
                </button>
                <a href="dashboard.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
        
        <!-- Alert container -->
        <div id="alert" class="alert"></div>

        <!-- Onboarding Guide -->
        <div id="onboarding-guide" class="onboarding-guide">
            <div class="guide-content">
                <h3 class="guide-title">ðŸš€ Get Started with Affiliate Marketing</h3>
                <p class="guide-description">
                    Connect your affiliate accounts to start earning commissions when your AI avatar recommends products to your fans.
                </p>
                <div class="guide-steps">
                    <div class="guide-step">1. Connect Platforms</div>
                    <div class="guide-step">2. Configure Products</div>
                    <div class="guide-step">3. Start Earning</div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="connected-platforms">0</div>
                <div class="stat-label">Connected Platforms</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-products">0</div>
                <div class="stat-label">Products Available</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recommendations-made">0</div>
                <div class="stat-label">Recommendations Made</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="earnings-potential">$0</div>
                <div class="stat-label">Potential Earnings</div>
            </div>
        </div>
        
        <!-- Platform Cards -->
        <div class="platform-cards" id="platform-cards">
            <!-- Platform cards will be dynamically generated -->
        </div>
    </main>

    <!-- Connect Platform Modal Step 1 -->
    <div id="connect-platform-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Connect Affiliate Platform</h3>
                <button class="modal-close" onclick="closeModal('connect-platform-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="progress-steps">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                    </div>
                </div>

                <h4 style="margin-bottom: 15px;">Choose a Platform to Connect</h4>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 0.9rem;">
                    Select an affiliate platform to connect to your account. We'll guide you through the setup process.
                </p>

                <div id="platform-selection" class="platform-selection">
                    <!-- Platform options will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('connect-platform-modal')">Cancel</button>
                <button id="continue-btn" class="btn" disabled onclick="proceedToStep2()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Connect Platform Modal Step 2 -->
    <div id="connect-platform-step2-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Connect <span id="selected-platform-name"></span></h3>
                <button class="modal-close" onclick="closeModal('connect-platform-step2-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="progress-steps">
                    <div class="step completed">
                        <div class="step-number">âœ“</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                    </div>
                </div>

                <div id="platform-config-form">
                    <!-- Platform-specific configuration form will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="goBackToStep1()">Back</button>
                <button id="connect-btn" class="btn btn-success" onclick="connectPlatform()">
                    <i class="fas fa-link"></i> Connect Platform
                </button>
            </div>
        </div>
    </div>

    <!-- Remove Platform Modal -->
    <div id="remove-platform-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Remove Platform</h3>
                <button class="modal-close" onclick="closeModal('remove-platform-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 15px;"></i>
                    <h4 style="margin-bottom: 10px;">Are you sure?</h4>
                    <p style="color: #64748b; margin-bottom: 20px;">
                        This will disconnect <strong id="platform-to-remove"></strong> from your account. 
                        You can reconnect it later, but you'll need to enter your credentials again.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('remove-platform-modal')">Cancel</button>
                <button id="confirm-remove-btn" class="btn btn-danger" onclick="confirmRemovePlatform()">
                    <i class="fas fa-trash"></i> Remove Platform
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:2000/api';

        // Global state
        let affiliateState = {
            platforms: [],
            selectedPlatform: null,
            stats: {
                connectedPlatforms: 0,
                totalProducts: 0,
                recommendationsMade: 0,
                earningsPotential: 0
            }
        };

        // Platform configurations
        const PLATFORM_CONFIGS = {
            amazon: {
                name: 'Amazon Associates',
                logo: 'A',
                fields: [
                    { id: 'access_key', label: 'Access Key', type: 'text', required: true },
                    { id: 'secret_key', label: 'Secret Key', type: 'password', required: true },
                    { id: 'partner_tag', label: 'Associate Tag', type: 'text', required: true }
                ],
                help: 'Get your credentials from the Amazon Associates program dashboard.'
            },
            rakuten: {
                name: 'Rakuten Advertising',
                logo: 'R',
                fields: [
                    { id: 'merchant_id', label: 'Merchant ID', type: 'text', required: true },
                    { id: 'token', label: 'API Token', type: 'password', required: true }
                ],
                help: 'Find your API credentials in your Rakuten Advertising account settings.'
            },
            shareasale: {
                name: 'ShareASale',
                logo: 'S',
                fields: [
                    { id: 'api_token', label: 'API Token', type: 'password', required: true },
                    { id: 'secret_key', label: 'Secret Key', type: 'password', required: true },
                    { id: 'affiliate_id', label: 'Affiliate ID', type: 'text', required: true }
                ],
                help: 'Get your API credentials from ShareASale\'s API documentation section.'
            },
            cj_affiliate: {
                name: 'CJ Affiliate',
                logo: 'CJ',
                fields: [
                    { id: 'api_key', label: 'API Key', type: 'password', required: true },
                    { id: 'website_id', label: 'Website ID', type: 'text', required: true }
                ],
                help: 'Access your API key from the CJ Affiliate developer portal.'
            },
            skimlinks: {
                name: 'Skimlinks',
                logo: 'SK',
                fields: [
                    { id: 'api_key', label: 'API Key', type: 'password', required: true },
                    { id: 'publisher_id', label: 'Publisher ID', type: 'text', required: true }
                ],
                help: 'Find your API credentials in the Skimlinks Hub under Developer Tools.'
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ”— Initializing Affiliate Management Dashboard...');
            
            if (!initializeAuth()) {
                return;
            }
            
            setupEventListeners();
            loadAffiliateData();
        });

        function initializeAuth() {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if (!token || !userStr) {
                console.warn('No authentication found, redirecting to login');
                window.location.href = '../pages/login.html';
                return false;
            }
            
            try {
                const user = JSON.parse(userStr);
                console.log('Authenticated user:', user.username);
                
                // Update UI with user info
                document.getElementById('user-name').textContent = user.username;
                if (user.username) {
                    const initials = user.username.split(' ')
                        .map(name => name[0])
                        .join('')
                        .toUpperCase()
                        .substring(0, 2);
                    document.getElementById('user-avatar').textContent = initials;
                }
                
                return true;
            } catch (error) {
                console.error('Error parsing user data:', error);
                window.location.href = '../pages/login.html';
                return false;
            }
        }

        function setupEventListeners() {
            // Connect platform button
            document.getElementById('connect-platform-btn').addEventListener('click', openConnectPlatformModal);
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '../pages/login.html';
            });
            
            // Modal close handlers
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    closeModal(e.target.id);
                }
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }

        async function loadAffiliateData() {
            try {
                console.log('ðŸ“Š Loading affiliate data...');
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/affiliate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        affiliateState.platforms = data.data.affiliate_links || [];
                        
                        console.log('âœ… Loaded affiliate data:', affiliateState.platforms);
                        
                        // Update stats
                        updateStats();
                        
                        // Render platform cards
                        renderPlatformCards();
                        
                        // Hide onboarding if platforms are connected
                        if (affiliateState.platforms.length > 0) {
                            document.getElementById('onboarding-guide').style.display = 'none';
                        }
                    } else {
                        console.warn('Failed to load affiliate data:', data.message);
                        showAlert('Failed to load affiliate data: ' + data.message, 'error');
                    }
                } else {
                    console.error('Failed to load affiliate data:', response.status);
                    showAlert('Failed to load affiliate data. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('Error loading affiliate data:', error);
                showAlert('Failed to load affiliate data: ' + error.message, 'error');
            }
        }

        function updateStats() {
            const stats = {
                connectedPlatforms: affiliateState.platforms.length,
                totalProducts: affiliateState.platforms.reduce((sum, p) => sum + (p.product_count || 0), 0),
                recommendationsMade: affiliateState.platforms.reduce((sum, p) => sum + (p.recommendations || 0), 0),
                earningsPotential: affiliateState.platforms.reduce((sum, p) => sum + (p.potential_earnings || 0), 0)
            };
            
            document.getElementById('connected-platforms').textContent = stats.connectedPlatforms;
            document.getElementById('total-products').textContent = stats.totalProducts.toLocaleString();
            document.getElementById('recommendations-made').textContent = stats.recommendationsMade.toLocaleString();
            document.getElementById('earnings-potential').textContent = `$${stats.earningsPotential.toLocaleString()}`;
            
            affiliateState.stats = stats;
        }

        function renderPlatformCards() {
            const container = document.getElementById('platform-cards');
            container.innerHTML = '';
            
            // Get all available platforms
            const allPlatforms = Object.keys(PLATFORM_CONFIGS);
            
            allPlatforms.forEach(platformKey => {
                const config = PLATFORM_CONFIGS[platformKey];
                const connected = affiliateState.platforms.find(p => p.platform === platformKey);
                
                const card = document.createElement('div');
                card.className = 'platform-card';
                card.innerHTML = `
                    <div class="platform-header">
                        <div class="platform-info">
                            <div class="platform-logo ${platformKey}">
                                ${config.logo}
                            </div>
                            <div class="platform-name">${config.name}</div>
                        </div>
                        <div class="platform-status ${connected ? 'status-connected' : 'status-disconnected'}">
                            ${connected ? 'âœ“ Connected' : 'â—‹ Not Connected'}
                        </div>
                    </div>
                    
                    <div class="platform-details">
                        ${connected ? `
                            <div class="detail-row">
                                <span class="detail-label">Affiliate ID:</span>
                                <span class="detail-value">${connected.affiliate_id}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Products Available:</span>
                                <span class="detail-value">${connected.product_count || 0}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Recommendations:</span>
                                <span class="detail-value">${connected.recommendations || 0}</span>
                            </div>
                        ` : `
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value">Ready to connect</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Commission:</span>
                                <span class="detail-value">Up to 10%</span>
                            </div>
                        `}
                    </div>
                    
                    <div class="platform-actions">
                        ${connected ? `
                            <button class="btn btn-secondary" onclick="copyAffiliateLink('${platformKey}')">
                                <i class="fas fa-copy"></i> Copy Link
                            </button>
                            <button class="btn btn-danger" onclick="removePlatform('${platformKey}', '${config.name}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        ` : `
                            <button class="btn" onclick="connectSpecificPlatform('${platformKey}')">
                                <i class="fas fa-plus"></i> Connect ${config.name}
                            </button>
                        `}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Modal Functions
        function openConnectPlatformModal() {
            renderPlatformSelection();
            openModal('connect-platform-modal');
        }

        function renderPlatformSelection() {
            const container = document.getElementById('platform-selection');
            container.innerHTML = '';
            
            Object.keys(PLATFORM_CONFIGS).forEach(platformKey => {
                const config = PLATFORM_CONFIGS[platformKey];
                const connected = affiliateState.platforms.find(p => p.platform === platformKey);
                
                if (connected) return; // Skip already connected platforms
                
                const option = document.createElement('div');
                option.className = 'platform-option';
                
                option.innerHTML = `
                    <input type="radio" name="platform" value="${platformKey}" style="margin-right: 15px; scale: 1.2;">
                    <div class="platform-logo ${platformKey}" style="margin-right: 15px;">${config.logo}</div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 5px;">${config.name}</div>
                        <div style="font-size: 0.8rem; color: #64748b;">
                            Connect your ${config.name} account to start earning commissions
                        </div>
                    </div>
                `;
                
                option.addEventListener('click', function() {
                    const radio = option.querySelector('input[type="radio"]');
                    radio.checked = true;
                    selectPlatform(platformKey);
                });
                
                container.appendChild(option);
            });
        }

        function selectPlatform(platformKey) {
            affiliateState.selectedPlatform = platformKey;
            
            // Update UI
            document.querySelectorAll('.platform-option').forEach(option => {
                const radio = option.querySelector('input');
                if (radio.value === platformKey) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Enable continue button
            document.getElementById('continue-btn').disabled = false;
        }

        function proceedToStep2() {
            if (!affiliateState.selectedPlatform) return;
            
            closeModal('connect-platform-modal');
            
            const config = PLATFORM_CONFIGS[affiliateState.selectedPlatform];
            document.getElementById('selected-platform-name').textContent = config.name;
            
            renderPlatformConfigForm();
            openModal('connect-platform-step2-modal');
        }

        function renderPlatformConfigForm() {
            const container = document.getElementById('platform-config-form');
            const config = PLATFORM_CONFIGS[affiliateState.selectedPlatform];
            
            container.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">
                        <i class="fas fa-info-circle"></i> Setup Instructions
                    </div>
                    <div style="font-size: 0.85rem; color: #64748b;">
                        ${config.help}
                    </div>
                </div>
                
                ${config.fields.map(field => `
                    <div class="form-group">
                        <label class="form-label" for="${field.id}">
                            ${field.label} ${field.required ? '<span style="color: #ef4444;">*</span>' : ''}
                        </label>
                        <input type="${field.type}" id="${field.id}" class="form-input" 
                               placeholder="Enter your ${field.label.toLowerCase()}"
                               ${field.required ? 'required' : ''}>
                    </div>
                `).join('')}
            `;
        }

        function goBackToStep1() {
            closeModal('connect-platform-step2-modal');
            openModal('connect-platform-modal');
        }

        async function connectPlatform() {
            try {
                const config = PLATFORM_CONFIGS[affiliateState.selectedPlatform];
                const formData = {};
                
                // Collect form data
                let isValid = true;
                config.fields.forEach(field => {
                    const input = document.getElementById(field.id);
                    const value = input.value.trim();
                    
                    if (field.required && !value) {
                        input.style.borderColor = '#ef4444';
                        isValid = false;
                    } else {
                        input.style.borderColor = '#d1d5db';
                        formData[field.id] = value;
                    }
                });
                
                if (!isValid) {
                    showAlert('Please fill in all required fields', 'error');
                    return;
                }
                
                // Show loading state
                const connectBtn = document.getElementById('connect-btn');
                const originalText = connectBtn.innerHTML;
                connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
                connectBtn.disabled = true;
                
                // Send request to connect platform
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/affiliate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: affiliateState.selectedPlatform,
                        ...formData
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert(`${config.name} connected successfully!`, 'success');
                        closeModal('connect-platform-step2-modal');
                        
                        // Reload data
                        await loadAffiliateData();
                    } else {
                        showAlert(data.message || 'Failed to connect platform', 'error');
                    }
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Failed to connect platform', 'error');
                }
                
                // Reset button
                connectBtn.innerHTML = originalText;
                connectBtn.disabled = false;
                
            } catch (error) {
                console.error('Error connecting platform:', error);
                showAlert('Failed to connect platform: ' + error.message, 'error');
                
                // Reset button
                const connectBtn = document.getElementById('connect-btn');
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect Platform';
                connectBtn.disabled = false;
            }
        }

        function connectSpecificPlatform(platformKey) {
            affiliateState.selectedPlatform = platformKey;
            proceedToStep2();
        }

        function copyAffiliateLink(platformKey) {
            const platform = affiliateState.platforms.find(p => p.platform === platformKey);
            if (platform) {
                const link = `https://yoursite.com/recommend?platform=${platformKey}&id=${platform.affiliate_id}`;
                navigator.clipboard.writeText(link).then(() => {
                    showAlert('Affiliate link copied to clipboard!', 'success');
                }).catch(() => {
                    showAlert('Failed to copy link', 'error');
                });
            }
        }

        function removePlatform(platformKey, platformName) {
            document.getElementById('platform-to-remove').textContent = platformName;
            document.getElementById('confirm-remove-btn').onclick = () => confirmRemovePlatform(platformKey);
            openModal('remove-platform-modal');
        }

        async function confirmRemovePlatform(platformKey) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/affiliate/${platformKey}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showAlert('Platform removed successfully', 'success');
                        closeModal('remove-platform-modal');
                        
                        // Reload data
                        await loadAffiliateData();
                    } else {
                        showAlert(data.message || 'Failed to remove platform', 'error');
                    }
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Failed to remove platform', 'error');
                }
                
            } catch (error) {
                console.error('Error removing platform:', error);
                showAlert('Failed to remove platform: ' + error.message, 'error');
            }
        }

        // Modal utilities
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Reset forms
            if (modalId === 'connect-platform-modal') {
                document.getElementById('continue-btn').disabled = true;
                affiliateState.selectedPlatform = null;
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
        }

        function showAlert(message, type = 'info', duration = 5000) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, duration);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        console.log('ðŸ”— Affiliate Management Dashboard loaded successfully');
    </script>
</body>
</html>