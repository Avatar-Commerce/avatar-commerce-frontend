<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Setup - AvatarCommerce</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9fb;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: #27293d;
            color: #fff;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }
        
        .logo span {
            color: #64dfdf;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-category {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            margin: 15px 20px 10px;
            letter-spacing: 1px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .menu-item.active {
            background-color: #5e60ce;
            color: #fff;
            border-left: 4px solid #64dfdf;
        }
        
        .menu-item i {
            margin-right: 10px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: absolute;
            bottom: 0;
            width: 100%;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #5e60ce;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-role {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Main content */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
            max-width: calc(100vw - 260px);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 600;
            color: #333;
        }
        
        .preview-chat-link {
            background-color: #5e60ce;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .preview-chat-link:hover {
            background-color: #4c4fb8;
        }
        
        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .alert-danger {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #f87171;
        }
        
        .alert-warning {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .alert-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        /* Cards */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background-color: #f8fafc;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Upload area */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #5e60ce;
            background-color: rgba(94, 96, 206, 0.02);
        }
        
        .upload-area.dragover {
            border-color: #5e60ce;
            background-color: rgba(94, 96, 206, 0.05);
        }
        
        .upload-icon {
            font-size: 48px;
            color: #5e60ce;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .upload-subtext {
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: #5e60ce;
            color: #fff;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #4c4fb8;
        }
        
        .btn-secondary {
            background-color: #f1f1fe;
            color: #5e60ce;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #e5e5fb;
        }
        
        .btn-success {
            background-color: #22c55e;
            color: #fff;
        }
        
        .btn-success:hover:not(:disabled) {
            background-color: #16a34a;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: #fff;
        }
        
        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }
        
        /* Preview */
        .preview-container {
            display: none;
            margin-top: 20px;
        }
        
        .preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .preview-info {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .preview-filename {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .preview-filesize {
            color: #666;
            font-size: 0.9rem;
        }
        
        .preview-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Avatar status section */
        .avatar-status-section {
            display: none;
        }
        
        .status-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .status-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status-text.status-training {
            color: #f59e0b;
        }
        
        .status-text.status-ready {
            color: #10b981;
        }
        
        .status-text.status-error {
            color: #ef4444;
        }
        
        .status-text.status-pending {
            color: #6b7280;
        }
        
        .avatar-id-display {
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            background-color: #f1f5f9;
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .avatar-preview {
            text-align: center;
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        
        .preview-placeholder {
            color: #9ca3af;
        }
        
        .preview-image-avatar, .preview-video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .avatar-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        /* Video generation section */
        .video-generation-section {
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #5e60ce;
            box-shadow: 0 0 0 3px rgba(94, 96, 206, 0.1);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
        }
        
        .loading-spinner {
            font-size: 2rem;
            color: #5e60ce;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.1rem;
            color: #333;
        }
        
        /* Instructions */
        .instructions {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .instructions-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .instructions-list {
            list-style: none;
            color: #075985;
        }
        
        .instructions-list li {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .instructions-list li:before {
            content: "âœ“";
            color: #059669;
            font-weight: bold;
            margin-top: 2px;
        }
        
        /* Responsive design */
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
                max-width: 100vw;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .avatar-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Sidebar navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">Avatar<span>Commerce</span></div>
        </div>
        
        <nav class="sidebar-menu">
            <div class="menu-category">GENERAL</div>
            <a href="dashboard.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="analytics.html" class="menu-item">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            
            <div class="menu-category">AVATAR</div>
            <a href="avatar-setup.html" class="menu-item active">
                <i class="fas fa-robot"></i>
                <span>Avatar Setup</span>
            </a>
            <a href="voice-setup.html" class="menu-item">
                <i class="fas fa-microphone"></i>
                <span>Voice Setup</span>
            </a>
            
            <div class="menu-category">MONETIZATION</div>
            <a href="products.html" class="menu-item">
                <i class="fas fa-tags"></i>
                <span>Products</span>
            </a>
            <a href="promotion-settings.html" class="menu-item">
                <i class="fas fa-bullhorn"></i>
                <span>Promotion Settings</span>
            </a>
            
            <div class="menu-category">ACCOUNT</div>
            <a href="settings.html" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div id="user-avatar" class="user-avatar">JD</div>
                <div class="user-details">
                    <div id="user-name" class="user-name">John Doe</div>
                    <div class="user-role">Influencer</div>
                </div>
            </div>
            <button id="logout-btn" class="logout-btn">Sign Out</button>
        </div>
    </aside>

    <!-- Main content area -->
    <main class="main-content">
        <div class="header">
            <h1 class="page-title">Avatar Setup</h1>
            <a id="preview-chat-link" href="#" class="preview-chat-link" target="_blank">
                <i class="fas fa-external-link-alt"></i>
                Preview Chat
            </a>
        </div>

        <!-- Alert container -->
        <div id="alert" class="alert"></div>

        <!-- Upload Section -->
        <div id="upload-section" class="card">
            <div class="card-header">
                <h3 class="card-title">Create Your Avatar</h3>
            </div>
            <div class="card-body">
                <!-- Upload Area -->
                <div id="upload-area" class="upload-area">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        Drop your image here or click to browse
                    </div>
                    <div class="upload-subtext">
                        Supported formats: JPG, PNG, WEBP (Max 10MB)
                    </div>
                    <button id="browse-btn" class="btn btn-primary">
                        <i class="fas fa-folder-open"></i>
                        Choose File
                    </button>
                    <input type="file" id="file-input" class="file-input" accept="image/*">
                </div>

                <!-- File Preview -->
                <div id="preview-container" class="preview-container">
                    <img id="preview-image" class="preview-image" alt="Preview">
                    <div class="preview-info">
                        <div id="preview-filename" class="preview-filename"></div>
                        <div id="preview-filesize" class="preview-filesize"></div>
                    </div>
                    <div class="preview-actions">
                        <button id="create-avatar-btn" class="btn btn-primary">
                            <i class="fas fa-magic"></i>
                            Create Avatar
                        </button>
                        <button id="change-file-btn" class="btn btn-secondary">
                            <i class="fas fa-exchange-alt"></i>
                            Change File
                        </button>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="instructions">
                    <div class="instructions-title">
                        <i class="fas fa-info-circle"></i>
                        Avatar Creation Tips
                    </div>
                    <ul class="instructions-list">
                        <li>Use a high-quality photo with good lighting</li>
                        <li>Make sure your face is clearly visible and centered</li>
                        <li>Avoid sunglasses, hats, or anything covering your face</li>
                        <li>Use a neutral background if possible</li>
                        <li>Avatar training takes 1-2 minutes to complete</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Avatar Status Section -->
        <div id="avatar-status-section" class="card avatar-status-section">
            <div class="card-header">
                <h3 class="card-title">Your Avatar</h3>
            </div>
            <div class="card-body">
                <!-- Status Display -->
                <div class="status-display">
                    <div id="avatar-status" class="status-text">Checking avatar status...</div>
                    <div id="avatar-id-display" class="avatar-id-display" style="display: none;"></div>
                </div>

                <!-- Avatar Preview -->
                <div id="avatar-preview" class="avatar-preview">
                    <div id="avatar-preview-placeholder" class="preview-placeholder">
                        <i class="fas fa-user-circle fa-5x"></i>
                        <p>Avatar Preview</p>
                    </div>
                    <img id="avatar-preview-image" class="preview-image-avatar" style="display: none;" alt="Avatar Preview">
                    <video id="avatar-preview-video" class="preview-video" style="display: none;" controls></video>
                </div>

                <!-- Avatar Controls -->
                <div id="avatar-controls" class="avatar-controls">
                    <button id="test-avatar-btn" class="btn btn-success" style="display: none;" disabled>
                        <i class="fas fa-play"></i>
                        Test Avatar
                    </button>
                    <button id="create-new-avatar-btn" class="btn btn-secondary" onclick="resetForNewAvatar()">
                        <i class="fas fa-plus"></i>
                        Create New Avatar
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Generation Section -->
        <div id="video-generation-section" class="card video-generation-section">
            <div class="card-header">
                <h3 class="card-title">Test Video Generation</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="test-message" class="form-label">Test Message:</label>
                    <textarea id="test-message" class="form-control" rows="3" placeholder="Enter a message to test your avatar...">Hello! This is a test of your custom AI avatar. I'm excited to chat with your fans and help promote your content!</textarea>
                </div>
                <button id="generate-test-video-btn" class="btn btn-primary" onclick="generateTestVideo()">
                    <i class="fas fa-video"></i>
                    Generate Test Video
                </button>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-spinner"></i>
            </div>
            <div id="loading-text" class="loading-text">Creating your avatar...</div>
        </div>
    </div>

    <!-- Load shared scripts -->
    <script src="../js/config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // API base URL
        const API_BASE_URL = CONFIG.API.BASE_URL;
        
        // Check if user is logged in
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        
        if (!token || !userStr) {
            window.location.href = '../login.html';
            return;
        }
        
        // Parse user data
        const user = JSON.parse(userStr);
        
        // Check if user is an influencer
        if (user.userType !== 'influencer') {
            window.location.href = '../login.html';
            return;
        }
        
        // Update user display
        document.getElementById('user-name').textContent = user.username;
        if (user.username) {
            const initials = user.username.split(' ')
                .map(name => name[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
            document.getElementById('user-avatar').textContent = initials;
        }
        
        // Set up preview chat link
        const previewChatLink = document.getElementById('preview-chat-link');
        if (previewChatLink && user) {
            const currentOrigin = window.location.origin;
            const chatUrl = `${currentOrigin}/pages/chat.html?username=${encodeURIComponent(user.username)}`;
            previewChatLink.href = chatUrl;
        }
        
        // Logout button
        document.getElementById('logout-btn').addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '../login.html';
        });
        
        // DOM elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const previewFilename = document.getElementById('preview-filename');
        const previewFilesize = document.getElementById('preview-filesize');
        const changeFileBtn = document.getElementById('change-file-btn');
        const createAvatarBtn = document.getElementById('create-avatar-btn');
        const uploadSection = document.getElementById('upload-section');
        const avatarStatusSection = document.getElementById('avatar-status-section');
        const avatarStatus = document.getElementById('avatar-status');
        const avatarIdDisplay = document.getElementById('avatar-id-display');
        const avatarPreview = document.getElementById('avatar-preview');
        const avatarPreviewPlaceholder = document.getElementById('avatar-preview-placeholder');
        const avatarPreviewImage = document.getElementById('avatar-preview-image');
        const avatarPreviewVideo = document.getElementById('avatar-preview-video');
        const testAvatarBtn = document.getElementById('test-avatar-btn');
        const videoGenerationSection = document.getElementById('video-generation-section');
        const alert = document.getElementById('alert');
        
        // File data
        let selectedFile = null;
        let currentAvatarId = null;
        
        // Check if user already has an avatar
        checkExistingAvatar();
        
        // Event listeners
        if (browseBtn) {
            browseBtn.addEventListener('click', function() {
                fileInput.click();
            });
        }
        
        if (fileInput) {
            fileInput.addEventListener('change', handleFileSelect);
        }
        
        if (changeFileBtn) {
            changeFileBtn.addEventListener('click', function() {
                resetFileSelection();
            });
        }
        
        if (createAvatarBtn) {
            createAvatarBtn.addEventListener('click', createAvatar);
        }
        
        if (testAvatarBtn) {
            testAvatarBtn.addEventListener('click', testAvatar);
        }
        
        // Drag and drop handlers
        if (uploadArea) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        }
        
        // Enhanced checkExistingAvatar function
        async function checkExistingAvatar() {
            try {
                console.log('Checking for existing avatar...');
                
                const response = await fetch(`${API_BASE_URL}/influencer/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load profile data');
                }
                
                const data = await response.json();
                console.log('Profile data:', data);
                
                if (data.status === 'success' && data.data.has_avatar && data.data.avatar_id) {
                    currentAvatarId = data.data.avatar_id;
                    
                    console.log('Found existing avatar:', currentAvatarId);
                    
                    // Update UI to show avatar exists
                    updateAvatarStatus(true, currentAvatarId, data.data.profile_image_url);
                    
                    console.log('Existing avatar loaded, checking readiness...');
                } else {
                    console.log('No existing avatar found');
                    updateAvatarStatus(false);
                }
            } catch (error) {
                console.error('Error checking existing avatar:', error);
                updateAvatarStatus(false);
            }
        }
        
        // File selection handlers
        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }
        
        // Validate file function
        function validateFile(file) {
            console.log('Validating file:', {
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: file.lastModified
            });
            
            // Get file extension
            const fileName = file.name.toLowerCase();
            const fileExtension = fileName.split('.').pop();
            
            // Define allowed extensions and MIME types
            const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp'];
            const allowedMimeTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            
            // Check file extension first (more reliable)
            if (!allowedExtensions.includes(fileExtension)) {
                throw new Error(`Invalid file extension: .${fileExtension}. Please use: ${allowedExtensions.map(ext => '.' + ext).join(', ')}`);
            }
            
            // Check MIME type if available (browsers sometimes don't set this correctly)
            if (file.type && file.type !== '' && !allowedMimeTypes.includes(file.type)) {
                console.warn(`MIME type mismatch: ${file.type}, but extension .${fileExtension} is allowed`);
                // Don't throw error for MIME type mismatch if extension is valid
            }
            
            // File size validation
            const maxSize = 10 * 1024 * 1024; // 10MB
            const minSize = 1024; // 1KB minimum
            
            if (file.size > maxSize) {
                throw new Error(`File too large: ${formatFileSize(file.size)}. Maximum size is ${formatFileSize(maxSize)}.`);
            }
            
            if (file.size < minSize) {
                throw new Error('File too small. Please select a proper image file.');
            }
            
            return true;
        }
        
        // Handle file function
        function handleFile(file) {
            console.log('Handling file:', {
                name: file.name,
                size: file.size,
                type: file.type || 'unknown',
                lastModified: file.lastModified
            });
            
            try {
                // Validate the file
                validateFile(file);
                
                // Store the selected file
                selectedFile = file;
                
                // Display the preview
                if (previewFilename) previewFilename.textContent = file.name;
                if (previewFilesize) previewFilesize.textContent = formatFileSize(file.size);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (previewImage) previewImage.src = e.target.result;
                    
                    // Show preview container, hide upload area
                    if (previewContainer) previewContainer.style.display = 'block';
                    if (uploadArea) uploadArea.style.display = 'none';
                    
                    console.log('File loaded successfully for preview');
                };
                
                reader.onerror = function(e) {
                    console.error('FileReader error:', e);
                    showAlert('Failed to read the selected file. Please try a different image.', 'danger');
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('File validation error:', error);
                showAlert(error.message, 'danger');
                resetFileSelection();
            }
        }
        
        // Reset file selection
        function resetFileSelection() {
            selectedFile = null;
            if (fileInput) fileInput.value = '';
            
            // Hide preview container, show upload area
            if (previewContainer) previewContainer.style.display = 'none';
            if (uploadArea) uploadArea.style.display = 'block';
        }
        
        // Create avatar function
        async function createAvatar() {
            if (!selectedFile) {
                showAlert('Please select an image file first.', 'danger');
                return;
            }
            
            // Re-validate file before upload
            try {
                validateFile(selectedFile);
            } catch (error) {
                showAlert(error.message, 'danger');
                return;
            }
            
            // Show loading state
            if (loadingText) loadingText.textContent = 'Creating your avatar... This may take 1-2 minutes.';
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
            if (createAvatarBtn) createAvatarBtn.disabled = true;
            
            try {
                // Create form data with the correct field name
                const formData = new FormData();
                formData.append('file', selectedFile);
                
                console.log('Sending avatar creation request...');
                console.log('File details:', {
                    name: selectedFile.name,
                    type: selectedFile.type || 'unknown',
                    size: selectedFile.size
                });
                
                const response = await fetch(`${API_BASE_URL}/avatar/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                        // Don't set Content-Type - let browser set it with boundary for multipart
                    },
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    throw new Error('Invalid response from server');
                }
                
                console.log('Avatar creation response:', data);
                
                if (data.status === 'success') {
                    // Avatar creation successful
                    currentAvatarId = data.data.avatar_id;
                    updateAvatarStatus(true, currentAvatarId, data.data.public_url);
                    
                    // Update user object in localStorage
                    user.has_avatar = true;
                    user.avatar_id = currentAvatarId;
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Show success message
                    showAlert('ðŸŽ‰ Avatar created successfully! Checking readiness for video generation...', 'success');
                    
                    // Hide the preview container
                    if (previewContainer) previewContainer.style.display = 'none';
                    resetFileSelection();
                    
                } else {
                    // Handle different error types
                    let errorMessage = data.message || 'Avatar creation failed. Please try again.';
                    
                    if (response.status === 400) {
                        errorMessage = `Upload Error: ${errorMessage}`;
                    } else if (response.status === 401) {
                        errorMessage = 'Authentication failed. Please log in again.';
                        // Redirect to login
                        setTimeout(() => {
                            localStorage.clear();
                            window.location.href = '../login.html';
                        }, 2000);
                    } else if (response.status === 403) {
                        errorMessage = 'Access forbidden. Please check your account permissions.';
                    } else if (response.status === 413) {
                        errorMessage = 'File too large. Please use a smaller image.';
                    } else if (response.status >= 500) {
                        errorMessage = `Server Error: ${errorMessage}`;
                    }
                    
                    showAlert(errorMessage, 'danger');
                    
                    // If we have debug info, log it
                    if (data.debug) {
                        console.log('Debug info:', data.debug);
                    }
                }
                
            } catch (error) {
                console.error('Avatar creation error:', error);
                
                let errorMessage = 'Network error. Please check your connection and try again.';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Cannot connect to server. Please check your internet connection.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showAlert(errorMessage, 'danger');
                
            } finally {
                // Hide loading state
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                if (createAvatarBtn) createAvatarBtn.disabled = false;
            }
        }
        
        // Update avatar status display
        function updateAvatarStatus(hasAvatar, avatarIdValue, imageUrl) {
            console.log('Updating avatar status:', { hasAvatar, avatarIdValue, imageUrl });
            
            if (hasAvatar && avatarIdValue) {
                // Store current avatar ID
                currentAvatarId = avatarIdValue;
                
                // Hide upload section and show avatar status section
                if (uploadSection) uploadSection.style.display = 'none';
                if (avatarStatusSection) avatarStatusSection.style.display = 'block';
                
                // Update status text
                if (avatarStatus) {
                    avatarStatus.textContent = 'Avatar created successfully - checking readiness...';
                    avatarStatus.className = 'status-text status-pending';
                }
                
                // Show avatar ID
                if (avatarIdDisplay) {
                    avatarIdDisplay.textContent = `Avatar ID: ${avatarIdValue}`;
                    avatarIdDisplay.style.display = 'block';
                }
                
                // Show avatar preview image if available
                if (imageUrl && avatarPreviewImage) {
                    avatarPreviewImage.src = imageUrl;
                    avatarPreviewImage.style.display = 'block';
                    if (avatarPreviewPlaceholder) {
                        avatarPreviewPlaceholder.style.display = 'none';
                    }
                }
                
                // Check if avatar is ready for video generation
                checkAvatarReadiness(avatarIdValue);
                
            } else {
                // No avatar - show upload interface
                if (uploadSection) uploadSection.style.display = 'block';
                if (avatarStatusSection) avatarStatusSection.style.display = 'none';
                if (videoGenerationSection) videoGenerationSection.style.display = 'none';
            }
        }
        
        // Check if avatar is ready for video generation
        async function checkAvatarReadiness(avatarIdValue) {
            if (!avatarIdValue) return;
            
            console.log('Checking avatar readiness for:', avatarIdValue);
            
            try {
                const response = await fetch(`${API_BASE_URL}/avatar/status/${avatarIdValue}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Avatar status check response:', data);
                    
                    if (data.status === 'success') {
                        const isReady = data.data.ready_for_video;
                        const trainingStatus = data.data.training_status;
                        
                        console.log(`Avatar ready: ${isReady}, Status: ${trainingStatus}`);
                        
                        if (isReady) {
                            // Avatar is ready!
                            if (avatarStatus) {
                                avatarStatus.textContent = 'Avatar ready for video generation!';
                                avatarStatus.className = 'status-text status-ready';
                            }
                            
                            if (testAvatarBtn) {
                                testAvatarBtn.disabled = false;
                                testAvatarBtn.style.display = 'block';
                            }
                            
                            // Show video generation section
                            if (videoGenerationSection) {
                                videoGenerationSection.style.display = 'block';
                            }
                            
                            showAlert('ðŸŽ‰ Your avatar is ready for video generation!', 'success');
                        } else {
                            // Avatar is still training
                            if (avatarStatus) {
                                avatarStatus.textContent = `Avatar training in progress (${trainingStatus || 'processing'})...`;
                                avatarStatus.className = 'status-text status-training';
                            }
                            
                            if (testAvatarBtn) {
                                testAvatarBtn.disabled = true;
                            }
                            
                            // Start polling for readiness
                            checkAvatarTrainingStatus(avatarIdValue);
                        }
                    }
                } else {
                    console.warn('Failed to check avatar status:', response.status);
                    if (avatarStatus) {
                        avatarStatus.textContent = 'Unable to check avatar status';
                        avatarStatus.className = 'status-text status-error';
                    }
                }
            } catch (error) {
                console.error('Error checking avatar readiness:', error);
                if (avatarStatus) {
                    avatarStatus.textContent = 'Error checking avatar status';
                    avatarStatus.className = 'status-text status-error';
                }
            }
        }
        
        // Enhanced avatar training status checker
        async function checkAvatarTrainingStatus(avatarId, maxAttempts = 15) {
            let attempts = 0;
            
            console.log(`Starting avatar training status check for: ${avatarId}`);
            
            const checkStatus = async () => {
                attempts++;
                console.log(`Avatar status check attempt ${attempts}/${maxAttempts}`);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/avatar/status/${avatarId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Training status response:', data);
                        
                        if (data.status === 'success') {
                            const trainingStatus = data.data.training_status;
                            const isReady = data.data.ready_for_video;
                            
                            console.log(`Training status: ${trainingStatus}, Ready: ${isReady}`);
                            
                            // Update UI based on status
                            if (avatarStatus) {
                                switch (trainingStatus) {
                                    case 'pending':
                                    case 'processing':
                                    case 'training':
                                        avatarStatus.textContent = `Avatar training in progress... (${trainingStatus})`;
                                        avatarStatus.className = 'status-text status-training';
                                        break;
                                    case 'completed':
                                    case 'ready':
                                        if (isReady) {
                                            avatarStatus.textContent = 'Avatar ready for video generation!';
                                            avatarStatus.className = 'status-text status-ready';
                                            
                                            if (testAvatarBtn) {
                                                testAvatarBtn.disabled = false;
                                                testAvatarBtn.style.display = 'block';
                                            }
                                            
                                            // Show video generation controls
                                            if (videoGenerationSection) {
                                                videoGenerationSection.style.display = 'block';
                                            }
                                            
                                            showAlert('ðŸŽ‰ Your avatar is now ready for video generation!', 'success');
                                            return; // Stop checking
                                        }
                                        break;
                                    case 'failed':
                                    case 'error':
                                        avatarStatus.textContent = 'Avatar training failed';
                                        avatarStatus.className = 'status-text status-error';
                                        showAlert('Avatar training failed. Please try creating a new avatar.', 'danger');
                                        return; // Stop checking
                                    default:
                                        avatarStatus.textContent = `Avatar status: ${trainingStatus}`;
                                        avatarStatus.className = 'status-text status-pending';
                                }
                            }
                            
                            // Continue checking if not completed or failed
                            if (!isReady && trainingStatus !== 'failed' && trainingStatus !== 'error' && attempts < maxAttempts) {
                                console.log(`Will check again in 20 seconds... (attempt ${attempts}/${maxAttempts})`);
                                setTimeout(checkStatus, 20000); // Check again in 20 seconds
                            } else if (attempts >= maxAttempts) {
                                console.log('Max attempts reached, stopping status checks');
                                if (!isReady && avatarStatus) {
                                    avatarStatus.textContent = 'Avatar training is taking longer than expected. Please refresh the page.';
                                    avatarStatus.className = 'status-text status-training';
                                }
                            }
                        }
                    } else {
                        console.warn('Failed to check avatar status:', response.status);
                        if (attempts < maxAttempts) {
                            setTimeout(checkStatus, 30000); // Try again in 30 seconds
                        }
                    }
                } catch (error) {
                    console.error('Error checking avatar status:', error);
                    if (attempts < maxAttempts) {
                        setTimeout(checkStatus, 30000); // Try again in 30 seconds
                    }
                }
            };
            
            // Start checking after 5 seconds
            setTimeout(checkStatus, 5000);
        }
        
        // Test avatar function
        async function testAvatar() {
            if (!currentAvatarId) {
                showAlert('No avatar found. Please create an avatar first.', 'danger');
                return;
            }
            
            // Show loading state
            if (avatarStatus) avatarStatus.textContent = 'Testing your avatar...';
            if (testAvatarBtn) {
                testAvatarBtn.disabled = true;
                testAvatarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            }
            
            try {
                const testData = {
                    text: "Hello! This is a test of your custom AI avatar. I'm excited to chat with your fans and help promote your content!",
                    avatar_id: currentAvatarId
                };
                
                console.log('Testing avatar:', testData);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout
                
                const response = await fetch(`${API_BASE_URL}/avatar/test-video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(testData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('Test response status:', response.status);
                
                const data = await response.json();
                console.log('Test response data:', data);
                
                if (response.ok && data.status === 'success') {
                    if (avatarStatus) avatarStatus.textContent = 'Test successful!';
                    
                    if (data.data.video_url && data.data.video_url.trim() !== '') {
                        console.log('Avatar video URL received:', data.data.video_url);
                        
                        // Show video preview
                        if (avatarPreviewVideo) {
                            avatarPreviewVideo.style.display = 'block';
                            avatarPreviewVideo.src = data.data.video_url;
                            
                            // Hide placeholder if showing
                            if (avatarPreviewPlaceholder) {
                                avatarPreviewPlaceholder.style.display = 'none';
                            }
                            
                            avatarPreviewVideo.onloadstart = function() {
                                if (avatarStatus) avatarStatus.textContent = 'Loading your avatar video...';
                            };
                            
                            avatarPreviewVideo.oncanplay = function() {
                                if (avatarStatus) avatarStatus.textContent = 'Your avatar is ready! Click play to watch.';
                            };
                            
                            avatarPreviewVideo.onerror = function(e) {
                                console.error('Video load error:', e);
                                if (avatarStatus) avatarStatus.textContent = 'Video generated but failed to load.';
                                showAlert('Avatar video was generated but failed to load. This might be temporary.', 'warning');
                            };
                        }
                        
                        showAlert('Avatar test completed successfully! Your avatar is working perfectly.', 'success');
                    } else {
                        console.log('No video URL in response');
                        if (avatarStatus) avatarStatus.textContent = 'Avatar responded but video generation may still be processing.';
                        showAlert('Your avatar responded! Video generation may take a bit longer.', 'warning');
                    }
                } else {
                    let errorMessage = data.message || 'Avatar test failed. Please try again.';
                    if (avatarStatus) avatarStatus.textContent = 'Test failed.';
                    showAlert(errorMessage, 'danger');
                }
                
            } catch (error) {
                console.error('Avatar test error:', error);
                
                let errorMessage = 'Test failed due to network error.';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Test timed out. Avatar video generation takes longer than expected.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to server. Please check your internet connection.';
                }
                
                if (avatarStatus) avatarStatus.textContent = 'Test failed.';
                showAlert(errorMessage, 'danger');
            } finally {
                // Reset button state
                if (testAvatarBtn) {
                    testAvatarBtn.disabled = false;
                    testAvatarBtn.innerHTML = '<i class="fas fa-play"></i> Test Avatar';
                }
            }
        }
        
        // Format file size helper
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Show alert function
        function showAlert(message, type = 'info') {
            try {
                const alertElement = document.getElementById('alert');
                if (!alertElement) {
                    console.log(`${type.toUpperCase()}: ${message}`);
                    return;
                }
                
                // Clear existing classes
                alertElement.className = 'alert';
                
                // Add type-specific class
                switch (type) {
                    case 'success':
                        alertElement.classList.add('alert-success');
                        break;
                    case 'danger':
                    case 'error':
                        alertElement.classList.add('alert-danger');
                        break;
                    case 'warning':
                        alertElement.classList.add('alert-warning');
                        break;
                    case 'info':
                    default:
                        alertElement.classList.add('alert-info');
                        break;
                }
                
                alertElement.textContent = message;
                alertElement.style.display = 'block';
                
                // Auto-hide after 8 seconds for success/info, longer for errors
                const hideDelay = (type === 'danger' || type === 'error') ? 12000 : 8000;
                setTimeout(() => {
                    if (alertElement.style.display !== 'none') {
                        alertElement.style.display = 'none';
                    }
                }, hideDelay);
                
                // Scroll to top to see alert
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error in showAlert function:', error);
                console.log(`${type.toUpperCase()}: ${message}`);
                
                // Fallback to browser alert for critical messages
                if (type === 'danger' || type === 'error') {
                    alert(message);
                }
            }
        }
        
        console.log('Avatar setup page initialized successfully');
        console.log('Current avatar ID:', currentAvatarId);
    });
    
    // Global functions for inline event handlers
    function resetForNewAvatar() {
        // Hide avatar sections
        const uploadSection = document.getElementById('upload-section');
        const avatarStatusSection = document.getElementById('avatar-status-section');
        const videoGenerationSection = document.getElementById('video-generation-section');
        
        if (avatarStatusSection) avatarStatusSection.style.display = 'none';
        if (videoGenerationSection) videoGenerationSection.style.display = 'none';
        if (uploadSection) uploadSection.style.display = 'block';
        
        // Reset variables
        currentAvatarId = null;
        selectedFile = null;
        
        // Reset file input
        const fileInput = document.getElementById('file-input');
        if (fileInput) fileInput.value = '';
        
        // Reset preview
        const previewContainer = document.getElementById('preview-container');
        const uploadArea = document.getElementById('upload-area');
        if (previewContainer) previewContainer.style.display = 'none';
        if (uploadArea) uploadArea.style.display = 'block';
        
        showAlert('Ready to create a new avatar. Please select an image file.', 'info');
    }
    
    // Generate test video
    async function generateTestVideo() {
        const message = document.getElementById('test-message').value.trim();
        const token = localStorage.getItem('token');
        
        if (!message) {
            showAlert('Please enter a test message.', 'danger');
            return;
        }
        
        if (!window.currentAvatarId) {
            showAlert('No avatar available for testing.', 'danger');
            return;
        }
        
        const generateBtn = document.getElementById('generate-test-video-btn');
        const originalText = generateBtn.innerHTML;
        
        try {
            // Show loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            const response = await fetch(`${CONFIG.API.BASE_URL}/avatar/test-video`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: message,
                    avatar_id: window.currentAvatarId
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success' && data.data.video_url) {
                // Show video
                const avatarPreviewVideo = document.getElementById('avatar-preview-video');
                if (avatarPreviewVideo) {
                    avatarPreviewVideo.src = data.data.video_url;
                    avatarPreviewVideo.style.display = 'block';
                    
                    // Hide placeholder if showing
                    const placeholder = document.getElementById('avatar-preview-placeholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }
                }
                
                showAlert('Test video generated successfully!', 'success');
            } else {
                showAlert(data.message || 'Failed to generate test video.', 'danger');
            }
            
        } catch (error) {
            console.error('Test video generation error:', error);
            showAlert('Error generating test video. Please try again.', 'danger');
        } finally {
            // Reset button
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
        }
    }
    
    function showAlert(message, type) {
        const alertElement = document.getElementById('alert');
        if (!alertElement) return;
        
        alertElement.className = 'alert alert-' + type;
        alertElement.textContent = message;
        alertElement.style.display = 'block';
        
        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 8000);
    }
    </script>
</body>
</html>